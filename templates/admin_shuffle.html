{% extends "base.html" %}

{% block title %}Shuffle - {{ reg_link.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-random"></i> Shuffle for "{{ reg_link.title }}"
            </h2>
            <div class="d-flex gap-2 align-items-center flex-wrap">
                <select class="form-select" id="saved-shuffles-dropdown" style="width: 200px;">
                    <option value="">Load Saved Shuffle...</option>
                </select>
                <select class="form-select" id="num-teams-dropdown" style="width: 150px;">
                    <option value="">Teams: Auto</option>
                </select>
                <button id="shuffle-button" class="btn btn-success" {% if players|length < 10 %}disabled{% endif %} style="min-width: 150px; white-space: nowrap;">
                    <i class="fas fa-dice"></i> Shuffle Teams
                </button>
                <a href="#" id="proceed-to-bracket-button" class="btn btn-primary disabled" style="min-width: 180px; white-space: nowrap;">
                    <i class="fas fa-sitemap"></i> Proceed to Bracket
                </a>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary" style="min-width: 180px; white-space: nowrap;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow registered-players-card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> Registered Players ({{ players|length }})
                </h5>
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                    <i class="fas fa-plus"></i> Add Player
                </button>
            </div>
            <div class="card-body">
                {% if players %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Player</th>
                                <th>MMR</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player in players %}
                            <tr id="player-row-{{ player.id }}" class="{{ 'player-absent' if player.status == 'Absent' else '' }}">
                                <td>
                                    <button class="btn btn-sm btn-toggle-status" data-player-id="{{ player.id }}">
                                        {% if player.status == 'Present' %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </button>
                                </td>
                                <td>{{ player.player_name }}</td>
                                <td>{{ player.mmr }}</td>
                                <td>
                                    <button class="icon-button btn-edit-player" data-player-id="{{ player.id }}" data-player-name="{{ player.player_name }}" data-player-mmr="{{ player.mmr }}">
                                        <i class="fas fa-edit text-primary"></i>
                                    </button>
                                    <button class="icon-button btn-delete-player" data-player-id="{{ player.id }}">
                                        <i class="fas fa-trash text-danger"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No players have registered for this event yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-balance-scale"></i> Shuffled Teams
                </h5>
            </div>
            <div class="card-body">
                <div id="teams-container" class="row">
                    <div class="col-12 text-center text-muted">
                        <p>Click the "Shuffle Teams" button to generate teams.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Add Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPlayerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_player_name" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="add_player_name" name="player_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="add_player_mmr" class="form-label">MMR</label>
                        <input type="number" class="form-control" id="add_player_mmr" name="mmr" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPlayerForm">
                <input type="hidden" id="edit_player_id" name="player_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_player_name" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="edit_player_name" name="player_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_player_mmr" class="form-label">MMR</label>
                        <input type="number" class="form-control" id="edit_player_mmr" name="mmr" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class.btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate team count dropdown based on present players
    const presentPlayerCount = {{ players|selectattr('status', 'equalto', 'Present')|list|length }};
    const maxTeams = Math.floor(presentPlayerCount / 5);
    const numTeamsDropdown = document.getElementById('num-teams-dropdown');

    if (maxTeams >= 2) {
        for (let i = 2; i <= maxTeams; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Teams: ${i} (${i * 5} players)`;
            numTeamsDropdown.appendChild(option);
        }
    }

    // Load saved shuffles into dropdown
    fetch(`/api/saved_shuffles/{{ reg_link.link_code }}`)
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById('saved-shuffles-dropdown');
            if (data.shuffles && data.shuffles.length > 0) {
                data.shuffles.forEach(shuffle => {
                    const option = document.createElement('option');
                    option.value = shuffle.id;
                    option.textContent = `${shuffle.created_at} - ${shuffle.num_teams} teams`;
                    dropdown.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading saved shuffles:', error));

    // Handle saved shuffle selection
    document.getElementById('saved-shuffles-dropdown').addEventListener('change', function() {
        const bracketId = this.value;
        if (!bracketId) return;

        fetch(`/api/load_shuffle/${bracketId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                    return;
                }

                // Display the loaded teams
                const teamsContainer = document.getElementById('teams-container');
                let html = '';

                data.teams.forEach(team => {
                    html += `
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card shuffle-card">
                                <div class="card-header bg-success text-white">
                                    ${team.name} (Avg. MMR: ${team.avg_mmr})
                                </div>
                                <ul class="list-group list-group-flush">
                                    ${team.players.map(player => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${player.name}</strong> (${player.mmr})
                                            </div>
                                            <div>
                                                ${player.roles.map(role => `<span class="badge bg-secondary">${role}</span>`).join(' ')}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });

                teamsContainer.innerHTML = html;

                // Enable proceed to bracket button
                document.getElementById('proceed-to-bracket-button').classList.remove('disabled');
                document.getElementById('proceed-to-bracket-button').href = `/admin/bracket/{{ reg_link.link_code }}`;
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred loading the shuffle.', 'error');
            });
    });

    // Shuffle button logic
    document.getElementById('shuffle-button').addEventListener('click', function() {
        const button = this;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Shuffling...';

        const numTeams = document.getElementById('num-teams-dropdown').value;
        const url = numTeams ? `/api/shuffle_teams/{{ reg_link.link_code }}?num_teams=${numTeams}` : `/api/shuffle_teams/{{ reg_link.link_code }}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                    return;
                }

                const teamsContainer = document.getElementById('teams-container');
                let html = '';

                data.teams.forEach(team => {
                    html += `
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card shuffle-card">
                                <div class="card-header bg-success text-white">
                                    ${team.name} (Avg. MMR: ${team.avg_mmr})
                                </div>
                                <ul class="list-group list-group-flush">
                                    ${team.players.map(player => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${player.name}</strong> (${player.mmr})
                                            </div>
                                            <div>
                                                ${player.roles.map(role => `<span class="badge bg-secondary">${role}</span>`).join(' ')}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });

                if (data.reserved.length > 0) {
                    html += `
                        <div class="col-12 mt-4">
                            <div class="card shuffle-card">
                                <div class="card-header bg-warning text-dark">
                                    Reserved Players
                                </div>
                                <ul class="list-group list-group-flush">
                                    ${data.reserved.map(player => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${player.name}</strong> (${player.mmr})
                                            </div>
                                            <div>
                                                ${player.roles.map(role => `<span class="badge bg-secondary">${role}</span>`).join(' ')}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                teamsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An unexpected error occurred. Please try again.', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-dice"></i> Shuffle Teams';
                document.getElementById('proceed-to-bracket-button').classList.remove('disabled');
                document.getElementById('proceed-to-bracket-button').href = `/admin/bracket/{{ reg_link.link_code }}`;
            });
    });

    // --- CRUD and Status Logic ---

    const addPlayerModal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
    const editPlayerModal = new bootstrap.Modal(document.getElementById('editPlayerModal'));

    // Add Player
    document.getElementById('addPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch(`/admin/event/{{ reg_link.link_code }}/add_player`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('Error: ' + data.error, 'error');
            } else {
                showToast('Player added successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        });
    });

    // Edit Player - Show modal
    document.querySelectorAll('.btn-edit-player').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.dataset.playerId;
            const playerName = this.dataset.playerName;
            const playerMmr = this.dataset.playerMmr;

            document.getElementById('edit_player_id').value = playerId;
            document.getElementById('edit_player_name').value = playerName;
            document.getElementById('edit_player_mmr').value = playerMmr;

            editPlayerModal.show();
        });
    });

    // Edit Player - Submit form
    document.getElementById('editPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const playerId = document.getElementById('edit_player_id').value;
        const formData = new FormData(this);
        fetch(`/admin/event/player/${playerId}/edit`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('Error: ' + data.error, 'error');
            } else {
                showToast('Player updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        });
    });

    // Delete Player
    document.querySelectorAll('.btn-delete-player').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this player?')) {
                const playerId = this.dataset.playerId;
                fetch(`/admin/event/player/${playerId}/delete`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('Error: ' + data.error, 'error');
                    } else {
                        showToast('Player deleted successfully!', 'success');
                        document.getElementById(`player-row-${playerId}`).remove();
                    }
                });
            }
        });
    });

    // Toggle Status
    document.querySelectorAll('.btn-toggle-status').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.dataset.playerId;
            fetch(`/admin/event/player/${playerId}/toggle_status`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    const playerRow = document.getElementById(`player-row-${playerId}`);
                    const statusIcon = this.querySelector('i');
                    showToast(`Player status changed to ${data.new_status}`, 'success');
                    if (data.new_status === 'Present') {
                        playerRow.classList.remove('player-absent');
                        statusIcon.classList.remove('fa-times-circle', 'text-danger');
                        statusIcon.classList.add('fa-check-circle', 'text-success');
                    } else {
                        playerRow.classList.add('player-absent');
                        statusIcon.classList.remove('fa-check-circle', 'text-success');
                        statusIcon.classList.add('fa-times-circle', 'text-danger');
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}
