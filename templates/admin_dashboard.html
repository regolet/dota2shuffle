{% extends "base.html" %}

{% block title %}Admin Dashboard - Dota 2 Shuffle{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-tachometer-alt"></i> Admin Dashboard
            </h2>
            <div>
                <a href="{{ url_for('admin_masterlist') }}" class="btn btn-outline-info me-2">
                    <i class="fas fa-users"></i> Player Masterlist
                </a>
                <span class="text-muted">Welcome, {{ admin.username }}</span>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-secondary btn-sm ms-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Nav Tabs -->
<ul class="nav nav-tabs mt-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration-panel" type="button" role="tab">
            <i class="fas fa-list"></i> Registration Links
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="lobby-tab" data-bs-toggle="tab" data-bs-target="#lobby-panel" type="button" role="tab">
            <i class="fas fa-users-cog"></i> Lobbies
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="adminTabsContent">
    <!-- Registration Links Panel -->
    <div class="tab-pane fade show active" id="registration-panel" role="tabpanel">
        <div class="card shadow mt-3">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Registration Links
                </h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createLinkModal">
                    <i class="fas fa-plus"></i> Create Registration Link
                </button>
            </div>
            <div class="card-body">
                {% if reg_links %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Link</th>
                                <th>Players</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Opens</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for link in reg_links %}
                            <tr>
                                <td>
                                    <strong>{{ link.title }}</strong>
                                    {% if link.description %}
                                        <br><small class="text-muted">{{ link.description[:50] }}{% if link.description|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <code class="small me-2" style="cursor: pointer;" 
                                              onclick="copyToClipboard('{{ request.url_root }}register/{{ link.link_code }}')"
                                              title="Click to copy link">
                                            {{ request.url_root }}register/{{ link.link_code }}
                                        </code>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="copyToClipboard('{{ request.url_root }}register/{{ link.link_code }}')"
                                                title="Copy registration link">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ link.players|length }}{% if link.max_players is not none %}/{{ link.max_players }}{% else %} (Unlimited){% endif %}</span>
                                </td>
                                <td>
                                    {% if link.is_active %}
                                        <span class="badge bg-success">Open</span>
                                    {% else %}
                                        <span class="badge bg-danger">Closed</span>
                                    {% endif %}
                                </td>
                                <td>{{ link.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if link.opens_at %}
                                        {{ link.opens_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">Immediate</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if link.expires_at %}
                                        {{ link.expires_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-toggle-link {% if link.is_active %}btn-success{% else %}btn-danger{% endif %}"
                                            data-link-id="{{ link.id }}"
                                            title="Toggle open/closed">
                                        <i class="fas fa-{% if link.is_active %}lock-open{% else %}lock{% endif %}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning btn-edit-link"
                                            data-link-id="{{ link.id }}"
                                            data-link-title="{{ link.title }}"
                                            data-link-description="{{ link.description or '' }}"
                                            data-link-max-players="{{ link.max_players or '' }}"
                                            data-link-unlimited="{{ 'true' if link.max_players is none else 'false' }}"
                                            data-link-opens="{{ link.opens_at.strftime('%Y-%m-%d %H:%M') if link.opens_at else '' }}"
                                            data-link-expires="{{ link.expires_at.strftime('%Y-%m-%d %H:%M') if link.expires_at else 'Never' }}"
                                            title="Edit registration link">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="{{ url_for('register', link_code=link.link_code) }}"
                                       class="btn btn-sm btn-outline-success" target="_blank"
                                       title="View registration page">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('admin_shuffle', link_code=link.link_code) }}"
                                       class="btn btn-sm btn-outline-primary"
                                       title="Manage shuffle and teams">
                                        <i class="fas fa-random"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-link"
                                            data-link-id="{{ link.id }}"
                                            data-link-title="{{ link.title }}"
                                            title="Delete registration link">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-link fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No registration links created yet</h5>
                    <p class="text-muted">Create your first registration link using the form above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Lobbies Panel -->
    <div class="tab-pane fade" id="lobby-panel" role="tabpanel">
        <div class="card shadow mt-3">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users-cog"></i> Lobbies
                </h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createLobbyModal">
                    <i class="fas fa-plus"></i> Create Lobby
                </button>
            </div>
            <div class="card-body">
                <div id="lobbies-list">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Loading lobbies...</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Registration Link Modal -->
<div class="modal fade" id="createLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Registration Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_create_link') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Event Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required
                               placeholder="e.g., Weekly Dota 2 Tournament">
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Optional description for the event"></textarea>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="unlimited_players" name="unlimited_players" checked>
                            <label class="form-check-label" for="unlimited_players">
                                Unlimited Players
                            </label>
                        </div>
                        <div id="max_players_group" style="display: none;" class="mt-2">
                            <label for="max_players" class="form-label">Max Players</label>
                            <input type="number" class="form-control" id="max_players" name="max_players"
                                   value="10" min="2" max="1000">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="opens_at" class="form-label">Opens At</label>
                        <input type="datetime-local" class="form-control" id="opens_at" name="opens_at">
                        <div class="form-text">Schedule when registration opens (leave empty for immediate opening)</div>
                    </div>

                    <div class="mb-3">
                        <label for="expires_at" class="form-label">Expires At *</label>
                        <input type="datetime-local" class="form-control" id="expires_at" name="expires_at" required>
                        <div class="form-text">Select when the registration link should expire</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-link"></i> Create Link
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Registration Link Modal -->
<div class="modal fade" id="editLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Registration Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editLinkForm">
                <input type="hidden" id="edit_link_id" name="link_id">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <strong><i class="fas fa-clock"></i> Current Expiration:</strong>
                        <span id="current_expiration">-</span>
                    </div>

                    <div class="mb-3">
                        <label for="edit_link_title" class="form-label">Event Title *</label>
                        <input type="text" class="form-control" id="edit_link_title" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_link_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_link_description" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_unlimited_players" name="unlimited_players">
                            <label class="form-check-label" for="edit_unlimited_players">
                                Unlimited Players
                            </label>
                        </div>
                        <div id="edit_max_players_group" class="mt-2">
                            <label for="edit_max_players" class="form-label">Max Players</label>
                            <input type="number" class="form-control" id="edit_max_players" name="max_players"
                                   value="10" min="2" max="1000">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_opens_at" class="form-label">Opens At</label>
                        <input type="datetime-local" class="form-control" id="edit_opens_at" name="opens_at">
                        <div class="form-text">Schedule when registration opens (leave empty for immediate opening)</div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_expires_at" class="form-label">Expires At *</label>
                        <input type="datetime-local" class="form-control" id="edit_expires_at" name="expires_at" required>
                        <div class="form-text">Select new expiration date and time</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Lobby Modal -->
<div class="modal fade" id="createLobbyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Lobby</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createLobbyForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="lobby_name" class="form-label">Lobby Name *</label>
                        <input type="text" class="form-control" id="lobby_name" name="lobby_name" required
                               placeholder="e.g., Friday Night Dota">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Lobby
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(function() {
            showCopySuccess(btn, originalHTML);
        }).catch(function(err) {
            console.error('Clipboard API failed: ', err);
            fallbackCopyToClipboard(text, btn, originalHTML);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyToClipboard(text, btn, originalHTML);
    }
}

function fallbackCopyToClipboard(text, btn, originalHTML) {
    // Create a temporary textarea element
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(btn, originalHTML);
        } else {
            showCopyError(btn, originalHTML);
        }
    } catch (err) {
        console.error('Fallback copy failed: ', err);
        showCopyError(btn, originalHTML);
    } finally {
        document.body.removeChild(textArea);
    }
}

function showCopySuccess(btn, originalHTML) {
    btn.innerHTML = '<i class="fas fa-check"></i>';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
    }, 2000);
}

function showCopyError(btn, originalHTML) {
    btn.innerHTML = '<i class="fas fa-times"></i>';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-danger');

    // Show the link in a toast notification
    const linkText = btn.closest('td').querySelector('code').textContent;
    showToast('Copy failed. Please manually copy this link: ' + linkText, 'error');

    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-outline-primary');
    }, 3000);
}

// Handle unlimited players checkbox
document.getElementById('unlimited_players').addEventListener('change', function() {
    const maxPlayersGroup = document.getElementById('max_players_group');
    if (this.checked) {
        maxPlayersGroup.style.display = 'none';
    } else {
        maxPlayersGroup.style.display = 'block';
    }
});

// Set default expiration to 24 hours from now for create modal
document.querySelector('[data-bs-target="#createLinkModal"]').addEventListener('click', function() {
    const now = new Date();
    now.setHours(now.getHours() + 24);
    const defaultExpiry = now.toISOString().slice(0, 16);
    document.getElementById('expires_at').value = defaultExpiry;
});

// Edit link modal
const editLinkModal = new bootstrap.Modal(document.getElementById('editLinkModal'));

document.querySelectorAll('.btn-edit-link').forEach(button => {
    button.addEventListener('click', function() {
        const linkId = this.dataset.linkId;
        const title = this.dataset.linkTitle;
        const description = this.dataset.linkDescription;
        const maxPlayers = this.dataset.linkMaxPlayers;
        const unlimited = this.dataset.linkUnlimited === 'true';
        const opens = this.dataset.linkOpens;
        const expires = this.dataset.linkExpires;

        document.getElementById('edit_link_id').value = linkId;
        document.getElementById('edit_link_title').value = title;
        document.getElementById('edit_link_description').value = description;
        document.getElementById('edit_unlimited_players').checked = unlimited;
        document.getElementById('current_expiration').textContent = expires;

        // Convert opens string to datetime-local format (YYYY-MM-DDTHH:MM)
        if (opens && opens !== '') {
            const opensDate = new Date(opens);
            const localDateTime = new Date(opensDate.getTime() - opensDate.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('edit_opens_at').value = localDateTime;
        } else {
            document.getElementById('edit_opens_at').value = '';
        }

        // Convert expires string to datetime-local format (YYYY-MM-DDTHH:MM)
        if (expires && expires !== 'Never') {
            const expiresDate = new Date(expires);
            const localDateTime = new Date(expiresDate.getTime() - expiresDate.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('edit_expires_at').value = localDateTime;
        }

        if (unlimited) {
            document.getElementById('edit_max_players_group').style.display = 'none';
        } else {
            document.getElementById('edit_max_players_group').style.display = 'block';
            document.getElementById('edit_max_players').value = maxPlayers;
        }

        editLinkModal.show();
    });
});

// Handle edit unlimited players checkbox
document.getElementById('edit_unlimited_players').addEventListener('change', function() {
    const maxPlayersGroup = document.getElementById('edit_max_players_group');
    if (this.checked) {
        maxPlayersGroup.style.display = 'none';
    } else {
        maxPlayersGroup.style.display = 'block';
    }
});

// Edit link form submission
document.getElementById('editLinkForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const linkId = document.getElementById('edit_link_id').value;
    const formData = new FormData(this);

    // Convert checkbox to true/false string
    formData.set('unlimited_players', document.getElementById('edit_unlimited_players').checked ? 'true' : 'false');

    fetch(`/admin/link/${linkId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            showToast('Link updated successfully!', 'success');
            editLinkModal.hide();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred. Please try again.', 'error');
    });
});

// Toggle link open/closed status
document.querySelectorAll('.btn-toggle-link').forEach(button => {
    button.addEventListener('click', function() {
        const linkId = this.dataset.linkId;
        const btn = this;

        if (confirm('Toggle this registration link open/closed status?')) {
            fetch(`/admin/link/${linkId}/toggle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    // Update button appearance and icon
                    if (data.is_active) {
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-success');
                        btn.innerHTML = '<i class="fas fa-lock-open"></i>';
                    } else {
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-danger');
                        btn.innerHTML = '<i class="fas fa-lock"></i>';
                    }

                    // Update status badge in table
                    const row = btn.closest('tr');
                    const statusCell = row.cells[3]; // Status column
                    if (data.is_active) {
                        statusCell.innerHTML = '<span class="badge bg-success">Open</span>';
                    } else {
                        statusCell.innerHTML = '<span class="badge bg-danger">Closed</span>';
                    }

                    showToast('Registration status updated successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            });
        }
    });
});

// Delete link
document.querySelectorAll('.btn-delete-link').forEach(button => {
    button.addEventListener('click', function() {
        const linkId = this.dataset.linkId;
        const linkTitle = this.dataset.linkTitle;

        if (confirm(`Are you sure you want to delete "${linkTitle}"?\n\nThis will also delete:\n- All registered players\n- All saved shuffles\n- All brackets and matches\n\nThis action cannot be undone!`)) {
            fetch(`/admin/link/${linkId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                } else {
                    showToast('Registration link deleted successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            });
        }
    });
});

// ========== LOBBY FUNCTIONALITY ==========

// Load lobbies when tab is clicked
document.getElementById('lobby-tab').addEventListener('click', function() {
    loadLobbies();
});

function loadLobbies() {
    fetch('/admin/lobbies')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('lobbies-list');
            if (data.lobbies && data.lobbies.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-hover">';
                html += '<thead><tr><th>Name</th><th>Link</th><th>Players</th><th>Parties</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

                data.lobbies.forEach(lobby => {
                    const lobbyUrl = `${window.location.origin}/lobby/${lobby.lobby_code}`;
                    html += `<tr>
                        <td><strong>${lobby.name}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <code class="small me-2">${lobbyUrl}</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${lobbyUrl}')" title="Copy lobby link">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                        <td><span class="badge bg-primary">${lobby.player_count}</span></td>
                        <td><span class="badge bg-success">${lobby.party_count}</span></td>
                        <td><span class="badge bg-${lobby.status === 'active' ? 'success' : 'secondary'}">${lobby.status}</span></td>
                        <td>
                            <a href="/admin/lobby/${lobby.lobby_code}/manage" class="btn btn-sm btn-outline-primary" title="Manage lobby">
                                <i class="fas fa-cog"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger btn-close-lobby" data-lobby-id="${lobby.id}" data-lobby-name="${lobby.name}" title="Close lobby">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;

                // Attach close lobby handlers
                document.querySelectorAll('.btn-close-lobby').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const lobbyId = this.dataset.lobbyId;
                        const lobbyName = this.dataset.lobbyName;
                        if (confirm(`Close lobby "${lobbyName}"?`)) {
                            fetch(`/admin/lobby/${lobbyId}/close`, { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    showToast(data.message || 'Lobby closed', 'success');
                                    loadLobbies();
                                });
                        }
                    });
                });
            } else {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No lobbies created yet</h5>
                        <p class="text-muted">Create your first lobby using the button above.</p>
                    </div>
                `;
            }
        });
}

// Create lobby form submission
document.getElementById('createLobbyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/admin/lobby/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            showToast('Lobby created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createLobbyModal')).hide();
            this.reset();
            loadLobbies();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred. Please try again.', 'error');
    });
});
</script>
{% endblock %}
