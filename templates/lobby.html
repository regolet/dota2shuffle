{% extends "base.html" %}

{% block title %}{{ lobby.name }} - Dota 2 Lobby{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="mb-4">
            <h2><i class="fas fa-users-cog"></i> {{ lobby.name }}</h2>
        </div>
    </div>
</div>

<!-- Join Modal -->
<div class="modal fade" id="joinModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Join Lobby</h5>
            </div>
            <form id="joinForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="player_name" class="form-label">Your Name *</label>
                        <input type="text" class="form-control" id="player_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="player_mmr" class="form-label">MMR *</label>
                        <input type="number" class="form-control" id="player_mmr" required min="0" max="15000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preferred Roles * (Select exactly 2)</label>
                        <small class="text-muted d-block mb-2" id="role-counter">0/2 selected</small>
                        <div class="form-check">
                            <input class="form-check-input role-checkbox" type="checkbox" value="Carry" id="role1">
                            <label class="form-check-label" for="role1">Carry</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input role-checkbox" type="checkbox" value="Midlane" id="role2">
                            <label class="form-check-label" for="role2">Midlane</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input role-checkbox" type="checkbox" value="Offlane" id="role3">
                            <label class="form-check-label" for="role3">Offlane</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input role-checkbox" type="checkbox" value="Support" id="role4">
                            <label class="form-check-label" for="role4">Support</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input role-checkbox" type="checkbox" value="Hard Support" id="role5">
                            <label class="form-check-label" for="role5">Hard Support</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="join-submit-btn">Join Lobby</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <!-- Players List (40% width) -->
    <div class="col-lg-4 col-md-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users"></i> Players</h5>
                <button class="btn btn-sm btn-light" id="create-party-btn" style="display: none;">
                    <i class="fas fa-plus"></i> Create Party
                </button>
            </div>
            <div class="card-body">
                <div id="players-list">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Loading players...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parties List (60% width with 2 columns) -->
    <div class="col-lg-8 col-md-7">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-user-friends"></i> Parties</h5>
            </div>
            <div class="card-body">
                <div id="parties-list" class="row">
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No parties formed yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invite Modal -->
<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Party Invitation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong id="invite-from"></strong> has invited you to join <strong id="invite-party"></strong>!</p>
                <input type="hidden" id="invite-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="decline-invite-btn">Decline</button>
                <button type="button" class="btn btn-success" id="accept-invite-btn">Accept</button>
            </div>
        </div>
    </div>
</div>

<!-- Join Request Modal (for party leaders) -->
<div class="modal fade" id="joinRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Join Request</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong id="request-player-name"></strong> wants to join <strong id="request-party-name"></strong>!</p>
                <input type="hidden" id="request-id">
                <input type="hidden" id="request-player-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="decline-request-btn">Decline</button>
                <button type="button" class="btn btn-success" id="accept-request-btn">Accept</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let socket = io();
let myPlayerId = null;
let myPartyId = null;
let lobbyCode = '{{ lobby.lobby_code }}';
let pendingInvites = {};
let allPlayers = [];

// Show join modal on load
document.addEventListener('DOMContentLoaded', function() {
    // Check if player has already joined this lobby
    const lobbyStorageKey = `lobby_${lobbyCode}_player`;
    const storedPlayer = localStorage.getItem(lobbyStorageKey);

    if (storedPlayer) {
        // Player has already joined, restore their session
        const playerData = JSON.parse(storedPlayer);
        myPlayerId = playerData.id;

        // Update navbar with player name
        document.getElementById('player-navbar-name').textContent = playerData.name;
        document.getElementById('player-navbar-status').style.display = 'inline';

        document.getElementById('create-party-btn').style.display = 'inline-block';

        // Join WebSocket room
        socket.emit('join_lobby', { lobby_code: lobbyCode });
    } else {
        // Show join modal for new players
        const joinModal = new bootstrap.Modal(document.getElementById('joinModal'));
        joinModal.show();
    }

    // Role selection counter and limit
    const roleCheckboxes = document.querySelectorAll('.role-checkbox');
    const roleCounter = document.getElementById('role-counter');
    const submitBtn = document.getElementById('join-submit-btn');

    roleCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.role-checkbox:checked').length;
            roleCounter.textContent = `${checkedCount}/2 selected`;

            // Disable unchecked boxes if 2 are already selected
            if (checkedCount >= 2) {
                roleCheckboxes.forEach(cb => {
                    if (!cb.checked) {
                        cb.disabled = true;
                    }
                });
            } else {
                roleCheckboxes.forEach(cb => cb.disabled = false);
            }
        });
    });
});

// Join form submission
document.getElementById('joinForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const playerName = document.getElementById('player_name').value;
    const playerMmr = parseInt(document.getElementById('player_mmr').value);
    const roles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(cb => cb.value);

    if (roles.length !== 2) {
        showToast('Please select exactly 2 roles', 'error');
        return;
    }

    fetch(`/api/lobby/${lobbyCode}/join`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            player_name: playerName,
            mmr: playerMmr,
            preferred_roles: roles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error && !data.player_id) {
            showToast(data.error, 'error');
        } else {
            myPlayerId = data.player_id;

            // Update navbar with player name
            document.getElementById('player-navbar-name').textContent = playerName;
            document.getElementById('player-navbar-status').style.display = 'inline';

            document.getElementById('create-party-btn').style.display = 'inline-block';
            bootstrap.Modal.getInstance(document.getElementById('joinModal')).hide();

            // Store player data in localStorage for this lobby
            const lobbyStorageKey = `lobby_${lobbyCode}_player`;
            localStorage.setItem(lobbyStorageKey, JSON.stringify({
                id: data.player_id,
                name: playerName
            }));

            // Join WebSocket room
            socket.emit('join_lobby', { lobby_code: lobbyCode });
        }
    });
});

// WebSocket event handlers
socket.on('lobby_state', function(data) {
    allPlayers = data.players;

    // Find if I'm in a party and set myPartyId
    const myPlayer = data.players.find(p => p.id === myPlayerId);
    if (myPlayer && myPlayer.party_id) {
        myPartyId = myPlayer.party_id;
        document.getElementById('create-party-btn').style.display = 'none';
    } else {
        myPartyId = null;
        document.getElementById('create-party-btn').style.display = 'inline-block';
    }

    updatePlayersList(data.players);
    updatePartiesList(data.parties);
});

socket.on('player_joined', function(data) {
    socket.emit('join_lobby', { lobby_code: lobbyCode });
});

socket.on('party_created', function(data) {
    if (data.leader_id === myPlayerId) {
        myPartyId = data.id;
        document.getElementById('create-party-btn').style.display = 'none';
    }
    socket.emit('join_lobby', { lobby_code: lobbyCode });
});

socket.on('party_updated', function(data) {
    socket.emit('join_lobby', { lobby_code: lobbyCode });
});

socket.on('party_disbanded', function(data) {
    if (data.party_id === myPartyId) {
        myPartyId = null;
        document.getElementById('create-party-btn').style.display = 'inline-block';
    }
    socket.emit('join_lobby', { lobby_code: lobbyCode });
});

socket.on('invite_received', function(data) {
    if (data.to_player_id === myPlayerId) {
        pendingInvites[data.invite_id] = data;
        showInviteModal(data);
    }
});

socket.on('invite_accepted', function(data) {
    if (data.player_id === myPlayerId) {
        myPartyId = data.party_id;
        document.getElementById('create-party-btn').style.display = 'none';
    }
    delete pendingInvites[data.invite_id];
    socket.emit('join_lobby', { lobby_code: lobbyCode });
});

socket.on('invite_declined', function(data) {
    delete pendingInvites[data.invite_id];
});

socket.on('join_request_received', function(data) {
    // Only show to party leader
    if (data.leader_id === myPlayerId) {
        showJoinRequestModal(data);
    }
});

socket.on('lobby_closed', function(data) {
    showToast(data.message, 'warning');
    setTimeout(() => window.location.href = '/', 3000);
});

socket.on('error', function(data) {
    showToast(data.message, 'error');
});

socket.on('party_notification', function(data) {
    showToast(data.message, data.type);
});

// Create party button
document.getElementById('create-party-btn').addEventListener('click', function() {
    socket.emit('create_party', { player_id: myPlayerId, lobby_code: lobbyCode });
});

// Invite modal handlers
const inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));

document.getElementById('accept-invite-btn').addEventListener('click', function() {
    const inviteId = parseInt(document.getElementById('invite-id').value);
    socket.emit('respond_invite', { invite_id: inviteId, accepted: true, lobby_code: lobbyCode });
    inviteModal.hide();
});

document.getElementById('decline-invite-btn').addEventListener('click', function() {
    const inviteId = parseInt(document.getElementById('invite-id').value);
    socket.emit('respond_invite', { invite_id: inviteId, accepted: false, lobby_code: lobbyCode });
    inviteModal.hide();
});

// Join request modal handlers
document.getElementById('accept-request-btn').addEventListener('click', function() {
    const requestId = parseInt(document.getElementById('request-id').value);
    const playerId = parseInt(document.getElementById('request-player-id').value);
    socket.emit('respond_invite', { invite_id: requestId, accepted: true, lobby_code: lobbyCode });
    bootstrap.Modal.getInstance(document.getElementById('joinRequestModal')).hide();
});

document.getElementById('decline-request-btn').addEventListener('click', function() {
    const requestId = parseInt(document.getElementById('request-id').value);
    const playerId = parseInt(document.getElementById('request-player-id').value);
    socket.emit('respond_invite', { invite_id: requestId, accepted: false, lobby_code: lobbyCode });
    bootstrap.Modal.getInstance(document.getElementById('joinRequestModal')).hide();
});

function showInviteModal(data) {
    document.getElementById('invite-from').textContent = data.from_player;
    document.getElementById('invite-party').textContent = data.party_name;
    document.getElementById('invite-id').value = data.invite_id;
    inviteModal.show();
}

function showJoinRequestModal(data) {
    document.getElementById('request-player-name').textContent = data.player_name;
    document.getElementById('request-party-name').textContent = data.party_name;
    document.getElementById('request-id').value = data.request_id;
    document.getElementById('request-player-id').value = data.player_id;

    const joinRequestModal = new bootstrap.Modal(document.getElementById('joinRequestModal'));
    joinRequestModal.show();
}

function updatePlayersList(players) {
    const container = document.getElementById('players-list');

    // Filter out players who are already in a party (status is 'in_party')
    const waitingPlayers = players.filter(player => player.status === 'waiting');

    if (waitingPlayers.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">All players are in parties</p></div>';
        return;
    }

    let html = '<div class="list-group">';
    waitingPlayers.forEach(player => {
        const isMe = player.id === myPlayerId;
        const rolesHtml = player.preferred_roles.map(r => `<span class="badge bg-secondary" style="font-size: 0.7rem;">${r}</span>`).join(' ');

        // Show invite button only if: I'm a party leader and it's not me
        const showInvite = myPartyId && !isMe;

        html += `
            <div class="list-group-item ${isMe ? 'player-current' : ''}" id="player-${player.id}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${player.player_name}</strong> ${isMe ? '<span class="badge bg-success">You</span>' : ''}
                                <span class="text-muted ms-2">(${player.mmr} MMR)</span>
                            </div>
                            <div class="text-end d-flex align-items-center gap-2">
                                <div>
                                    ${rolesHtml}
                                </div>
                                ${showInvite ? `
                                    <button class="btn btn-sm btn-primary" onclick="invitePlayer(${player.id}, '${player.player_name}')">
                                        <i class="fas fa-user-plus"></i> Invite
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updatePartiesList(parties) {
    const container = document.getElementById('parties-list');
    if (parties.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No parties formed yet</p></div>';
        return;
    }

    let html = '';
    parties.forEach(party => {
        const statusClass = party.status === 'ready' ? 'bg-success' : 'bg-warning';
        const statusText = party.status === 'ready' ? 'Ready (5/5)' : `Forming (${party.members.length}/5)`;
        const isMyParty = party.id === myPartyId;
        const amILeader = party.leader_id === myPlayerId;

        // Border color matches party status
        const borderClass = isMyParty ? (party.status === 'ready' ? 'border-success' : 'border-warning') : '';
        const shadowColor = party.status === 'ready' ? 'rgba(25, 135, 84, 0.5)' : 'rgba(255, 193, 7, 0.5)';

        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100 ${borderClass}" style="${isMyParty ? `border-width: 4px !important; box-shadow: 0 0 10px ${shadowColor};` : ''}" id="party-${party.id}">
                <div class="card-header ${statusClass} text-white d-flex justify-content-between align-items-center">
                    <strong>${party.party_name}</strong>
                    <div>
                        <span class="me-2">${statusText}</span>
                        ${!isMyParty && !myPartyId && party.members.length < 5 ? `<button class="btn btn-sm btn-info" onclick="requestJoinParty(${party.id}, '${party.party_name.replace(/'/g, "\\'")}')"><i class="fas fa-sign-in-alt"></i> Request Join</button> ` : ''}
                        ${party.members.length === 5 && amILeader && party.status !== 'ready' ? `<button class="btn btn-sm btn-light" onclick="markPartyReady(${party.id})"><i class="fas fa-check"></i> Ready</button> ` : ''}
                        ${amILeader ? `<button class="btn btn-sm btn-danger" onclick="disbandParty(${party.id})"><i class="fas fa-trash"></i> Disband</button>` : ''}
                    </div>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
        `;

        party.members.forEach(member => {
            const isLeader = member.id === party.leader_id;
            const rolesHtml = member.preferred_roles.map(r => `<span class="badge bg-secondary" style="font-size: 0.7rem;">${r}</span>`).join(' ');
            const isMe = member.id === myPlayerId;

            html += `
                <div class="list-group-item ${isMe ? 'player-current' : ''}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${member.player_name}</strong>
                                    ${isLeader ? ' ðŸ‘‘' : ''}
                                    ${isMe ? '<span class="badge bg-success ms-2">You</span>' : ''}
                                    <span class="text-muted ms-2">(${member.mmr} MMR)</span>
                                </div>
                                <div class="text-end d-flex align-items-center gap-2">
                                    <div>
                                        ${rolesHtml}
                                    </div>
                                    ${isMe && !isLeader ? `
                                        <button class="btn btn-sm btn-danger" onclick="leaveParty()">Leave</button>
                                    ` : ''}
                                    ${amILeader && !isMe && member.id !== party.leader_id ? `
                                        <button class="btn btn-sm btn-warning" onclick="kickMember(${member.id}, '${member.player_name}')">
                                            <i class="fas fa-times"></i> Kick
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                    </div>
                </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function invitePlayer(playerId, playerName) {
    if (!myPartyId) {
        showToast('You must be in a party to invite players', 'error');
        return;
    }

    socket.emit('send_invite', {
        party_id: myPartyId,
        from_player_id: myPlayerId,
        to_player_id: playerId,
        lobby_code: lobbyCode
    });

    showToast(`Invitation sent to ${playerName}`, 'success');
}

function requestJoinParty(partyId, partyName) {
    if (myPartyId) {
        showToast('You are already in a party', 'warning');
        return;
    }

    socket.emit('request_join_party', {
        party_id: partyId,
        player_id: myPlayerId,
        lobby_code: lobbyCode
    });

    showToast(`Join request sent to ${partyName}`, 'success');
}

function leaveParty() {
    if (!myPartyId) return;

    socket.emit('leave_party', {
        player_id: myPlayerId,
        party_id: myPartyId,
        lobby_code: lobbyCode
    });

    myPartyId = null;
    document.getElementById('create-party-btn').style.display = 'inline-block';
}

function markPartyReady(partyId) {
    socket.emit('mark_party_ready', {
        party_id: partyId,
        lobby_code: lobbyCode
    });
}

function disbandParty(partyId) {
    if (confirm('Are you sure you want to disband this party?')) {
        socket.emit('disband_party', {
            party_id: partyId,
            lobby_code: lobbyCode
        });
    }
}

function kickMember(playerId, playerName) {
    if (confirm(`Are you sure you want to kick ${playerName} from the party?`)) {
        socket.emit('kick_member', {
            player_id: playerId,
            party_id: myPartyId,
            lobby_code: lobbyCode
        });
    }
}
</script>
{% endblock %}
