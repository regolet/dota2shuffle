{% extends "base.html" %}

{% block title %}Shuffle - {{ reg_link.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-dice"></i> {{ reg_link.title }} - Team Shuffle
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Registered Players ({{ players|length }}{% if reg_link.max_players is not none %}/{{ reg_link.max_players }}{% endif %})</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>MMR</th>
                                        <th>Roles</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in players %}
                                    <tr>
                                        <td>{{ player.player_name }}</td>
                                        <td><span class="badge bg-primary">{{ player.mmr }}</span></td>
                                        <td>
                                            {% set roles = player.preferred_roles|from_json %}
                                            {% for role in roles %}
                                                <span class="badge bg-secondary me-1">{{ role.replace('_', ' ').title() }}</span>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Shuffle Controls</h6>
                        <div class="d-grid gap-2">
                            <button id="shuffleBtn" class="btn btn-success btn-lg" 
                                    {% if players|length < 2 %}disabled{% endif %}>
                                <i class="fas fa-dice"></i> Shuffle Teams
                            </button>
                            <small class="text-muted text-center">
                                {% if players|length < 2 %}
                                    Need at least 2 players to shuffle
                                {% else %}
                                    Click to create balanced teams
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-balance-scale"></i> Shuffled Teams
                </h5>
            </div>
            <div class="card-body">
                <div id="teamsResult" class="row">
                    <div class="col-12 text-center text-muted">
                        <p>Click the "Shuffle Teams" button to generate balanced teams.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4" id="balanceCard" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h6>Team Balance</h6>
                <div id="balanceInfo" class="text-muted"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('shuffleBtn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Shuffling...';

    fetch(`/api/shuffle_teams/{{ reg_link.link_code }}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast(data.error, 'error');
                return;
            }

            // Display teams
            displayTeams(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error shuffling teams. Please try again.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
});

function displayTeams(data) {
    // Check if we have teams data
    if (!data.teams || data.teams.length === 0) {
        showToast('No teams generated. Please try again.', 'warning');
        return;
    }

    const teamsContainer = document.getElementById('teamsResult');
    let html = '';

    // Display all teams
    data.teams.forEach(team => {
        html += `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">${team.name}</h6>
                        <small>Avg. MMR: ${team.avg_mmr}</small>
                    </div>
                    <ul class="list-group list-group-flush">
                        ${team.players.map(player => `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${player.name}</strong>
                                        <br>
                                        <span class="badge bg-primary">${player.mmr} MMR</span>
                                    </div>
                                    <div class="text-end">
                                        ${player.roles.map(role => `<span class="badge bg-secondary mb-1">${role}</span>`).join('<br>')}
                                    </div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;
    });

    // Display reserved players if any
    if (data.reserved && data.reserved.length > 0) {
        html += `
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-users"></i> Reserved Players (${data.reserved.length})
                        </h6>
                        <small>Not enough for complete team</small>
                    </div>
                    <ul class="list-group list-group-flush">
                        ${data.reserved.map(player => `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${player.name}</strong>
                                        <span class="badge bg-primary ms-2">${player.mmr} MMR</span>
                                    </div>
                                    <div>
                                        ${player.roles.map(role => `<span class="badge bg-secondary">${role}</span>`).join(' ')}
                                    </div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    teamsContainer.innerHTML = html;

    // Calculate and display balance info
    if (data.teams.length >= 2) {
        const mmrs = data.teams.map(t => t.avg_mmr);
        const maxMMR = Math.max(...mmrs);
        const minMMR = Math.min(...mmrs);
        const mmrDiff = maxMMR - minMMR;
        const avgMMR = Math.round(mmrs.reduce((a, b) => a + b, 0) / mmrs.length);

        const balanceInfo = document.getElementById('balanceInfo');
        const balanceCard = document.getElementById('balanceCard');

        let balanceText = `${data.teams.length} teams created | Average MMR: ${avgMMR} | MMR Range: ${mmrDiff}`;

        if (mmrDiff <= 100) {
            balanceInfo.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> Excellent balance! ${balanceText}</span>`;
        } else if (mmrDiff <= 200) {
            balanceInfo.innerHTML = `<span class="text-info"><i class="fas fa-info-circle"></i> Good balance. ${balanceText}</span>`;
        } else if (mmrDiff <= 300) {
            balanceInfo.innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Fair balance. ${balanceText}</span>`;
        } else {
            balanceInfo.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> Unbalanced teams. ${balanceText}</span>`;
        }

        balanceCard.style.display = 'block';
    }

    // Scroll to results
    teamsContainer.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
